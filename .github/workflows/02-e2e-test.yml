name: 02 - E2E Selenium Tests

on:
  workflow_run:
    workflows: ["01 - Integration & Smoke Test"] 
    types:
      - completed

jobs:
  # ------------------------------------------------------------------
  # JOB 4: E2E Selenium (Login -> Create Listing -> Upload -> Submit)
  # ------------------------------------------------------------------
  e2e-selenium:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    env:
      BASE_URL: http://localhost:3000
      TEST_EMAIL: ${{ secrets.TEST_EMAIL }}
      TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
      HEADLESS: "1"
      ARTIFACTS_DIR: artifacts
      E2E_WAIT: "25"
      E2E_ALERT_WAIT: "40"
      E2E_SUBMIT_WAIT: "150"
      E2E_IMAGE_FILE: "bmw-x5-2.webp"
      E2E_DATA_FILE: "create_listing_valid.json"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # Tái tạo môi trường Docker (Cần thiết vì đây là máy ảo mới)
      - name: Create Backend .env
        run: |
          cd backend
          echo "PORT=4000" > .env
          echo "NODE_ENV=test" >> .env
          echo "DB_HOST=database" >> .env 
          echo "DB_PORT=5432" >> .env
          echo "DB_USER=postgres" >> .env
          echo "DB_PASSWORD=password123" >> .env
          echo "DB_NAME=cartradingstore" >> .env
          echo "JWT_SECRET=ci_smoke_test_secret" >> .env
          echo "SUPABASE_URL=https://fake.supabase.co" >> .env
          echo "SUPABASE_KEY=fake-key" >> .env
          echo "SUPABASE_SERVICE_KEY=fake-key" >> .env
          echo "SUPABASE_ANON_KEY=fake-key" >> .env

      - name: Create Frontend .env
        run: |
          cd frontend
          echo "NEXT_PUBLIC_API_URL=http://localhost:4000" > .env

      - name: Start Containers
        run: |
          docker compose up -d --build
          sleep 10
          docker compose ps

      - name: Wait for Frontend
        run: |
          for i in {1..60}; do
            if curl -fsS http://localhost:3000 >/dev/null; then
              echo "Frontend up"
              exit 0
            fi
            sleep 2
          done
          docker compose logs --no-color --tail=200
          exit 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Selenium test deps
        working-directory: selenium_tests
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run E2E tests
        working-directory: selenium_tests
        run: |
          pytest -q -m e2e

      - name: Upload Selenium artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: selenium-artifacts
          path: selenium_tests/artifacts

      - name: Dump Docker Logs on Failure
        if: failure()
        run: |
          docker compose logs --no-color --tail=400

      - name: Stop Containers
        if: always()
        run: docker compose down -v