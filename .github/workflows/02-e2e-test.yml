name: 02 - E2E Selenium Tests

on:
  workflow_run:
    workflows: ["01 - Integration & Smoke Test"]
    types:
      - completed

jobs:
  # ------------------------------------------------------------------
  # JOB 4: E2E Selenium (Login -> Create Listing -> Upload -> Submit)
  # ------------------------------------------------------------------
  e2e-selenium:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    env:
      BASE_URL: http://localhost:3000
      TEST_EMAIL: ${{ secrets.TEST_EMAIL }}
      TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
      HEADLESS: "1"
      ARTIFACTS_DIR: artifacts
      E2E_WAIT: "60"
      E2E_ALERT_WAIT: "40"
      E2E_SUBMIT_WAIT: "150"
      E2E_IMAGE_FILE: "bmw-x5-2.webp"
      E2E_DATA_FILE: "create_listing_valid.json"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. Táº¡o Environment Variables
      - name: Create Backend .env
        run: |
          cd backend
          echo "PORT=4000" > .env
          echo "NODE_ENV=test" >> .env
          echo "DB_HOST=database" >> .env
          echo "DB_PORT=5432" >> .env
          echo "DB_USER=postgres" >> .env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
          echo "DB_NAME=cartradingstore" >> .env
          echo "JWT_SECRET=ci_smoke_test_secret" >> .env
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> .env
          echo "SUPABASE_SERVICE_KEY=${{ secrets.SUPABASE_SERVICE_KEY }}" >> .env
          echo "SUPABASE_BUCKET=cars" >> .env

      - name: Create Frontend .env
        run: |
          cd frontend
          echo "INTERNAL_API_BASE=http://backend:4000" > .env
          echo "NEXT_PUBLIC_API_URL=/api" >> .env

      # 2. Khá»Ÿi Ä‘á»™ng Container
      - name: Start Containers
        run: |
          docker compose up -d --build
          echo " Containers started. Waiting for DBase..."
          sleep 10

      # 3. Cháº¯c cháº¯n DB Ä‘Ã£ sá»‘ng trÆ°á»›c khi Seed
      - name: Wait for Database Ready
        run: |
          timeout 60s bash -c 'until docker compose exec -T database pg_isready; do echo "Waiting for DB..."; sleep 2; done'

      # 4. QUAN TRá»ŒNG: Seed dá»¯ liá»‡u sáº¡ch (DÃ¹ng docker exec cho tiá»‡n, khÃ´ng cáº§n cÃ i psql host)
      - name: Reset & Seed Database
        run: |
          echo "ðŸ“‚ Copying SQL files..."
          docker compose cp backend/config/seed.sql database:/seed.sql

          echo "ðŸ§¹ Cleaning & Seeding..."
          # TRUNCATE Ä‘á»ƒ xÃ³a sáº¡ch dá»¯ liá»‡u rÃ¡c náº¿u cÃ³, trÃ¡nh duplicate
          docker compose exec -T database psql -U postgres -d cartradingstore -c "TRUNCATE TABLE brands, provinces, districts, models, listings RESTART IDENTITY CASCADE;"
          # Náº¡p dá»¯ liá»‡u
          docker compose exec -T database psql -U postgres -d cartradingstore -f /seed.sql

          # Verify ngay láº­p tá»©c
          docker compose exec -T database psql -U postgres -d cartradingstore -c "SELECT count(*) FROM brands;"

      # 5. QUAN TRá»ŒNG NHáº¤T: Restart Ä‘á»ƒ Backend nháº­n dá»¯ liá»‡u má»›i
      - name: Restart Services
        run: |
          echo "ðŸ”„ Restarting Backend & Frontend to refresh data cache..."
          docker compose restart backend frontend
          sleep 15

      - name: Verify INTERNAL_API_BASE exists
        run: |
          docker compose exec -T frontend sh -lc 'echo "INTERNAL_API_BASE=$INTERNAL_API_BASE"'

      # 6. Kiá»ƒm tra API tháº­t sá»± cÃ³ dá»¯ liá»‡u chÆ°a (KhÃ´ng chá»‰ check 200 OK)
      - name: Verify Backend Data (Check Brands > 0)
        run: |
          echo "ðŸ” Checking if Brands are loaded..."
          # Script nÃ y check xem máº£ng tráº£ vá» cÃ³ Ä‘á»™ dÃ i > 0 khÃ´ng
          docker compose exec -T frontend node -e '
            const http = require("http");
            const req = http.request({
              hostname: "backend", port: 4000, path: "/api/listings/brands", method: "GET"
            }, res => {
              let data = "";
              res.on("data", chunk => data += chunk);
              res.on("end", () => {
                const json = JSON.parse(data);
                console.log("Response:", json);
                // Kiá»ƒm tra xem cÃ³ dá»¯ liá»‡u brands khÃ´ng
                if (res.statusCode === 200 && json.data && json.data.length > 0) {
                  console.log("âœ… Brands loaded successfully!");
                  process.exit(0);
                } else {
                  console.error("âŒ API 200 OK but NO DATA!");
                  process.exit(1);
                }
              });
            });
            req.on("error", (e) => { console.error(e); process.exit(1); });
            req.end();
          '

      # 7. Setup & Run Test
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Selenium test deps
        working-directory: selenium_tests
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run E2E tests
        working-directory: selenium_tests
        run: |
          pytest -q -m e2e

      - name: Upload Selenium artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: selenium-artifacts
          path: selenium_tests/artifacts

      - name: Dump Docker Logs on Failure
        if: failure()
        run: |
          docker compose logs --no-color --tail=400

      - name: Stop Containers
        if: always()
        run: docker compose down -v
