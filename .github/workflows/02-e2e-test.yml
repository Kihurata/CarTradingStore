name: 02 - E2E Selenium Tests

on:
  workflow_run:
    workflows: ["01 - Integration & Smoke Test"]
    types:
      - completed

jobs:
  # ------------------------------------------------------------------
  # JOB 4: E2E Selenium (Login -> Create Listing -> Upload -> Submit)
  # ------------------------------------------------------------------
  e2e-selenium:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    env:
      BASE_URL: http://localhost:3000
      TEST_EMAIL: ${{ secrets.TEST_EMAIL }}
      TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
      HEADLESS: "1"
      ARTIFACTS_DIR: artifacts
      E2E_WAIT: "60"
      E2E_ALERT_WAIT: "40"
      E2E_SUBMIT_WAIT: "150"
      E2E_IMAGE_FILE: "bmw-x5-2.webp"
      E2E_DATA_FILE: "create_listing_valid.json"
      NEXT_PUBLIC_API_URL: http://backend:4000

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # T√°i t·∫°o m√¥i tr∆∞·ªùng Docker
      - name: Create Backend .env
        run: |
          cd backend
          echo "PORT=4000" > .env
          echo "NODE_ENV=test" >> .env
          echo "DB_HOST=database" >> .env
          echo "DB_PORT=5432" >> .env
          echo "DB_USER=postgres" >> .env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
          echo "DB_NAME=cartradingstore" >> .env
          echo "JWT_SECRET=ci_smoke_test_secret" >> .env
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> .env
          echo "SUPABASE_SERVICE_KEY=${{ secrets.SUPABASE_SERVICE_KEY }}" >> .env
          echo "SUPABASE_BUCKET=cars" >> .env

      - name: Create Frontend .env
        run: |
          cd frontend
          echo "INTERNAL_API_BASE=http://backend:4000" > .env
          echo "NEXT_PUBLIC_API_URL=/api" >> .env

      - name: Start Containers
        run: |
          docker compose up -d --build
          echo "üöÄ Containers started. Waiting for DB initialization..."
          sleep 10
          docker compose ps

      - name: Wait for Backend Ready (inside Docker network)
          run: |
            for i in {1..40}; do
              if docker compose exec -T frontend node -e "
                const http=require('http');
                const req=http.request({hostname:'backend',port:4000,path:'/api/listings/brands',method:'GET'},res=>{
                  process.exit(res.statusCode===200?0:1);
                });
                req.on('error',()=>process.exit(1));
                req.end();
              "; then
                echo "‚úÖ Backend is reachable from frontend!"
                exit 0
              fi
              echo "Waiting for backend... ($i)"
              sleep 3
            done
            echo "‚ùå Backend not reachable in time"
            docker compose logs --no-color --tail=200 backend
            exit 1


      - name: Seed Database for E2E
        run: |
          sudo apt-get update && sudo apt-get install -y postgresql-client
          export PGPASSWORD=${{ secrets.DB_PASSWORD }}
          psql -h localhost -p 5432 -U postgres -d cartradingstore -f backend/config/init.sql
          psql -h localhost -p 5432 -U postgres -d cartradingstore -f backend/config/seed.sql

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Selenium test deps
        working-directory: selenium_tests
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run E2E tests
        working-directory: selenium_tests
        run: |
          pytest -q -m e2e

      - name: Upload Selenium artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: selenium-artifacts
          path: selenium_tests/artifacts

      - name: Dump Docker Logs on Failure
        if: failure()
        run: |
          docker compose logs --no-color --tail=400

      - name: Stop Containers
        if: always()
        run: docker compose down -v
