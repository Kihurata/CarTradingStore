name: CI/CD Pipeline (Test & Auto-Deploy)

on:
  push:
    branches: ["deploy"]
permissions:
  contents: read
  issues: write
jobs:
  # ------------------------------------------------------------------
  # JOB 1: BACKEND (Test Unit, Integration & Build Check)
  # ------------------------------------------------------------------
  # backend-ci:
  #   runs-on: ubuntu-latest

  #   services:
  #     postgres:
  #       image: postgres:15-alpine
  #       env:
  #         POSTGRES_USER: user_test
  #         POSTGRES_PASSWORD: password_fake
  #         POSTGRES_DB: cartradingstore_test
  #       ports:
  #         - 5432:5432
  #       options: >-
  #         --health-cmd pg_isready
  #         --health-interval 10s
  #         --health-timeout 5s
  #         --health-retries 5

  #   steps:
  #     - name: Checkout Code
  #       uses: actions/checkout@v3

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: "18"
  #         cache: "npm"
  #         cache-dependency-path: "./backend/package-lock.json"

  #     - name: Install Dependencies
  #       run: |
  #         cd backend
  #         npm ci

  #     - name: Create Dummy .env
  #       run: |
  #         cd backend
  #         echo "PORT=4000" >> .env
  #         echo "NODE_ENV=test" >> .env
  #         echo "DB_HOST=localhost" >> .env
  #         echo "DB_PORT=5432" >> .env
  #         echo "DB_USER=user_test" >> .env
  #         echo "DB_PASSWORD=password_fake" >> .env
  #         echo "DB_NAME=cartradingstore_test" >> .env
  #         echo "JWT_SECRET=super_fake_secret_key" >> .env
  #         echo "SUPABASE_URL=https://fake-url.supabase.co" >> .env
  #         echo "SUPABASE_KEY=fake-key" >> .env

  #     - name: Prepare Database & Run Tests
  #       run: |
  #         sudo apt-get update && sudo apt-get install -y postgresql-client
  #         export PGPASSWORD=password_fake
  #         sleep 5
  #         psql -h localhost -p 5432 -U user_test -d cartradingstore_test -f backend/config/init.sql
  #         psql -h localhost -p 5432 -U user_test -d cartradingstore_test -f backend/config/seed.sql

  #         cd backend
  #         npm run test:unit -- --coverage
  #         npm run test:int -- --runInBand --forceExit

  #     - name: Verify Backend Docker Build
  #       run: |
  #         cd backend
  #         docker build . -t backend-test-build

  # ------------------------------------------------------------------
  # JOB 2: FRONTEND (Build Check)
  # ------------------------------------------------------------------
  # frontend-ci:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout Code
  #       uses: actions/checkout@v3

  #     - name: Verify Frontend Docker Build
  #       run: |
  #         cd frontend
  #         docker build . -t frontend-test-build --build-arg NEXT_PUBLIC_API_URL=http://localhost:4000

  # ------------------------------------------------------------------
  # JOB 3: SMOKE TEST (System Health Check)
  # ------------------------------------------------------------------
  # smoke-test:
  #   # Ch·ªâ ch·∫°y khi code ƒë√£ build OK
  #   needs: [backend-ci, frontend-ci]
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout Code
  #       uses: actions/checkout@v3

  #     # 1. T·∫°o file .env cho Backend (S·ª¨A L·ªñI ENV T·∫†I ƒê√ÇY)
  #     - name: Create Backend .env
  #       run: |
  #         cd backend
  #         echo "PORT=4000" > .env
  #         echo "NODE_ENV=test" >> .env
  #         echo "DB_HOST=database" >> .env
  #         echo "DB_PORT=5432" >> .env
  #         echo "DB_USER=postgres" >> .env
  #         echo "DB_PASSWORD=password123" >> .env
  #         echo "DB_NAME=cartradingstore" >> .env
  #         echo "JWT_SECRET=ci_smoke_test_secret" >> .env
  #         echo "SUPABASE_URL=https://fake.supabase.co" >> .env
  #         echo "SUPABASE_KEY=fake-key" >> .env
  #         echo "SUPABASE_SERVICE_KEY=fake-key" >> .env
  #         echo "SUPABASE_ANON_KEY=fake-key" >> .env
  #         # --------------------------------------------------------------

  #     # 2. T·∫°o file .env cho Frontend
  #     - name: Create Frontend .env
  #       run: |
  #         cd frontend
  #         echo "NEXT_PUBLIC_API_URL=http://localhost:4000" > .env

  #     # 3. Build v√† Ch·∫°y Docker Compose
  #     - name: Start Containers
  #       run: |
  #         docker compose up -d --build
  #         echo "Containers are starting..."
  #         sleep 10 # ƒê·ª£i m·ªôt ch√∫t cho DB init xong
  #         docker compose ps

  #     # 4. Ch·∫°y Script Smoke Test (ƒê∆∞·ªùng d·∫´n ƒë√£ ƒë√∫ng)
  #     - name: Run Smoke Test Script
  #       run: |
  #         chmod +x backend/tests/smoke/run_smoke.sh
  #         ./backend/tests/smoke/run_smoke.sh

  #     # 5. Debug log
  #     - name: Dump Docker Logs on Failure
  #       if: failure()
  #       run: |
  #         echo "=== DATABASE LOGS ==="
  #         docker compose logs database
  #         echo "=== BACKEND LOGS ==="
  #         docker compose logs backend
  #         echo "=== FRONTEND LOGS ==="
  #         docker compose logs frontend
  #         docker compose down

  #     - name: Stop Containers
  #       if: always()
  #       run: docker compose down

  # ------------------------------------------------------------------
  # JOB 4: E2E Selenium (Login -> Create Listing -> Upload -> Submit)
  # ------------------------------------------------------------------
  e2e-selenium:
    # needs: [smoke-test]
    runs-on: ubuntu-latest

    env:
      BASE_URL: http://localhost:3000
      TEST_EMAIL: ${{ secrets.TEST_EMAIL }}
      TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
      HEADLESS: "1"
      ARTIFACTS_DIR: artifacts
      E2E_WAIT: "60"
      E2E_ALERT_WAIT: "40"
      E2E_SUBMIT_WAIT: "150"
      E2E_IMAGE_FILE: "bmw-x5-2.webp"
      E2E_DATA_FILE: "create_listing_valid.json"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Create Backend .env
        run: |
          cd backend
          echo "PORT=4000" > .env
          echo "NODE_ENV=test" >> .env
          echo "DB_HOST=database" >> .env
          echo "DB_PORT=5432" >> .env
          echo "DB_USER=postgres" >> .env
          echo "DB_PASSWORD=password123" >> .env
          echo "DB_NAME=cartradingstore" >> .env
          echo "JWT_SECRET=ci_smoke_test_secret" >> .env
          echo "SUPABASE_URL=https://fake.supabase.co" >> .env
          echo "SUPABASE_KEY=fake-key" >> .env
          echo "SUPABASE_SERVICE_KEY=fake-key" >> .env
          echo "SUPABASE_ANON_KEY=fake-key" >> .env

      - name: Create Frontend .env
        run: |
          cd frontend
          echo "NEXT_PUBLIC_API_URL=http://backend:4000" > .env

      - name: Start Containers
        run: |
          docker compose up -d --build
          echo "üöÄ Containers started. Waiting for DB initialization..."
          sleep 10

      # B∆Ø·ªöC M·ªöI: KI·ªÇM TRA S·ª®C KH·ªéE DB TR∆Ø·ªöC KHI N·∫†P
      - name: Wait for Database Ready
        run: |
          # V√≤ng l·∫∑p ch·ªù t·ªëi ƒëa 60s cho ƒë·∫øn khi Database tr·∫£ l·ªùi "I'm ready"
          timeout 60s bash -c 'until docker compose exec -T database pg_isready; do echo "Waiting for DB..."; sleep 2; done'

      # B∆Ø·ªöC QUAN TR·ªåNG NH·∫§T: RESET & FORCE SEED
      - name: Reset DB & Force Seed (Clean State)
        run: |
          echo "üìÇ Copying SQL files..."
          docker compose cp backend/config/seed.sql database:/seed.sql

          echo "üßπ Cleaning old data (TRUNCATE)..."
          # X√≥a s·∫°ch d·ªØ li·ªáu ƒëang load d·ªü dang ho·∫∑c b·ªã tr√πng
          docker compose exec -T database psql -U postgres -d cartradingstore -c "TRUNCATE TABLE brands, provinces, districts, models, listings RESTART IDENTITY CASCADE;"

          echo "üå± Seeding fresh data..."
          docker compose exec -T database psql -U postgres -d cartradingstore -f /seed.sql

          echo "üîç VERIFICATION: Checking Brands Count..."
          # Ki·ªÉm tra ngay l·∫≠p t·ª©c xem c√≥ bao nhi√™u h√£ng xe
          docker compose exec -T database psql -U postgres -d cartradingstore -c "SELECT count(*) FROM brands;"

          echo "üîÑ Restarting Backend to load new data..."
          docker compose restart backend

      # TƒÇNG TH·ªúI GIAN CH·ªú FRONTEND/BACKEND
      - name: Wait for Frontend & Backend Ready
        run: |
          echo "‚è≥ Waiting for services to stabilize..."
          # Ch·ªù backend kh·ªüi ƒë·ªông l·∫°i v√† k·∫øt n·ªëi DB
          sleep 15

          # Check Frontend k·ªπ h∆°n
          for i in {1..30}; do
            if curl -fsS http://localhost:3000 >/dev/null; then
              echo "‚úÖ Frontend is up!"
              exit 0
            fi
            echo "Waiting for frontend..."
            sleep 2
          done
          echo "‚ùå Frontend failed to start in time"
          docker compose logs frontend
          exit 1

      - name: Debug API Connectivity
        run: |
          echo "Testing Connectivity from Host to Backend..."
          curl -v http://localhost:4000/api/listings/brands || echo "Warning: Host cannot reach Backend directly"

          echo "Testing Connectivity inside Docker Network..."
          # L·ªánh n√†y gi·∫£ l·∫≠p vi·ªác Frontend g·ªçi Backend
          docker compose exec -T frontend curl -v http://backend:4000/api/listings/brands || echo "‚ùå Frontend cannot reach Backend!"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Selenium test deps
        working-directory: selenium_tests
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run E2E tests
        working-directory: selenium_tests
        run: |
          pytest -q -m e2e

      - name: Upload Selenium artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: selenium-artifacts
          path: selenium_tests/artifacts

      - name: Dump Docker Logs on Failure
        if: failure()
        run: |
          docker compose logs --no-color --tail=400

      - name: Stop Containers
        if: always()
        run: docker compose down -v

  # ------------------------------------------------------------------
  # JOB 5: DEPLOY TO RENDER
  # ------------------------------------------------------------------
  deploy-production:
    # needs: [smoke-test, e2e-selenium]
    needs: [e2e-selenium]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/deploy'
    steps:
      - name: Trigger Render Deploy (Backend)
        run: curl -X POST ${{ secrets.RENDER_BACKEND_HOOK }}

      - name: Trigger Render Deploy (Frontend)
        run: curl -X POST ${{ secrets.RENDER_FRONTEND_HOOK }}

  # ------------------------------------------------------------------
  # JOB 6: B√ÅO L·ªñI
  # ------------------------------------------------------------------
  report-failure:
    # Th√™m smoke-test v√†o danh s√°ch needs
    # needs: [backend-ci, frontend-ci, smoke-test, deploy-production]
    needs: [deploy-production]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Create Issue on Failure
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "üö® CI/CD Failed: ${{ github.workflow }} #${{ github.run_number }}" \
            --body "Pipeline th·∫•t b·∫°i t·∫°i commit: ${{ github.sha }}.%0A%0AXem chi ti·∫øt logs t·∫°i ƒë√¢y: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --label "bug" \
            --assignee "${{ github.actor }}"
