name: 03 - Production Deploy

on:
  workflow_run:
    workflows: ["02 - E2E Selenium Tests"]
    branches: ["deploy"]
    types:
      - completed

permissions:
  contents: read
  issues: write

jobs:
  # ------------------------------------------------------------------
  # JOB 5: DEPLOY TO RENDER
  # ------------------------------------------------------------------
  deploy-production:
    # Ch·ªâ ch·∫°y khi File 2 th√†nh c√¥ng
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    # Logic ki·ªÉm tra nh√°nh ƒë√£ ƒë∆∞·ª£c handle ·ªü ph·∫ßn 'on', nh∆∞ng gi·ªØ l·∫°i cho ch·∫Øc ch·∫Øn
    steps:
      - name: Trigger Render Deploy (Backend)
        run: curl -X POST ${{ secrets.RENDER_BACKEND_HOOK }}

      - name: Trigger Render Deploy (Frontend)
        run: curl -X POST ${{ secrets.RENDER_FRONTEND_HOOK }}

  # ------------------------------------------------------------------
  # JOB 6: B√ÅO L·ªñI
  # ------------------------------------------------------------------
  report-failure:
    needs: [deploy-production]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Create Issue on Failure
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "üö® CI/CD Failed: ${{ github.workflow }} #${{ github.run_number }}" \
            --body "Pipeline th·∫•t b·∫°i t·∫°i commit: ${{ github.sha }}.%0A%0AXem chi ti·∫øt logs t·∫°i ƒë√¢y: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --label "bug" \
            --assignee "${{ github.actor }}"