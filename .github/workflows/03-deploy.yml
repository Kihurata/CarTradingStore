name: 03 - Production Deploy

on:
  workflow_run:
    workflows: ["02 - E2E Selenium Tests"]
    branches: ["deploy"]
    types:
      - completed

permissions:
  contents: read
  issues: write

jobs:
  # ------------------------------------------------------------------
  # JOB 5: DEPLOY TO RENDER
  # ------------------------------------------------------------------
  deploy-production:
    # Chỉ chạy khi File 2 thành công
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Render Deploy (Backend)
        run: curl -X POST ${{ secrets.RENDER_BACKEND_HOOK }}

      - name: Trigger Render Deploy (Frontend)
        run: curl -X POST ${{ secrets.RENDER_FRONTEND_HOOK }}

  # ------------------------------------------------------------------
  # JOB 6: BÁO LỖI
  # ------------------------------------------------------------------
  report-failure:
    needs: [deploy-production]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Create Issue on Failure
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title " CI/CD Failed: ${{ github.workflow }} #${{ github.run_number }}" \
            --body "Pipeline thất bại tại commit: ${{ github.sha }}.%0A%0AXem chi tiết logs tại đây: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --label "bug" \
            --assignee "${{ github.actor }}"